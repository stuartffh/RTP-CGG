<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel Administrativo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="container py-5">
  <h1 class="mb-4">Painel Administrativo</h1>
  <button onclick="logout()" class="btn btn-secondary mb-3">Sair</button>
  <form id="user-form">
    <input type="hidden" id="user-id" />
    <div class="mb-3">
      <label class="form-label" for="form-username">Usuário</label>
      <input class="form-control" id="form-username" required />
    </div>
    <div class="mb-3">
      <label class="form-label" for="form-password">Senha</label>
      <input type="password" class="form-control" id="form-password" />
    </div>
    <div class="mb-3">
      <label class="form-label" for="form-ip">IP liberado (separado por vírgulas)</label>
      <input class="form-control" id="form-ip" />
    </div>
    <button class="btn btn-primary" type="submit">Salvar</button>
  </form>
  <hr />
  <table class="table" id="users-table">
    <thead>
      <tr>
        <th>ID</th><th>Usuário</th><th>IP Liberado</th><th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
<script>
const token = localStorage.getItem('token');
if(!token){ location.href='/login'; }
function api(path, options={}){
  options.headers = options.headers || {};
  options.headers['Authorization'] = 'Bearer ' + token;
  if(options.body && !(options.body instanceof FormData)){
    options.headers['Content-Type'] = 'application/json';
    options.body = JSON.stringify(options.body);
  }
  return fetch(path, options);
}
function loadUsers(){
  api('/api/users').then(r=>r.json()).then(data=>{
    const tbody=document.querySelector('#users-table tbody');
    tbody.innerHTML='';
    data.forEach(u=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${u.id}</td><td>${u.username}</td><td>${u.ip_liberado||''}</td><td>
        <button class="btn btn-sm btn-warning" onclick="editUser(${u.id},'${u.username}','${u.ip_liberado||''}')">Editar</button>
        <button class="btn btn-sm btn-danger ms-2" onclick="deleteUser(${u.id})">Excluir</button>
      </td>`;
      tbody.appendChild(tr);
    });
  });
}
function editUser(id, username, ip){
  document.getElementById('user-id').value=id;
  document.getElementById('form-username').value=username;
  document.getElementById('form-ip').value=ip;
}
document.getElementById('user-form').addEventListener('submit',function(e){
  e.preventDefault();
  const id=document.getElementById('user-id').value;
  const data={username:document.getElementById('form-username').value,
              password:document.getElementById('form-password').value,
              ip_liberado:document.getElementById('form-ip').value};
  const method=id?'PUT':'POST';
  const url=id?'/api/users/'+id:'/api/users';
  api(url,{method,body:data}).then(r=>r.json()).then(()=>{this.reset();document.getElementById('user-id').value='';loadUsers();});
});
function deleteUser(id){
  if(confirm('Confirmar exclusão?')){
    api('/api/users/'+id,{method:'DELETE'}).then(()=>loadUsers());
  }
}
function logout(){
  localStorage.removeItem('token');
  location.href='/login';
}
loadUsers();
</script>
</body>
</html>
